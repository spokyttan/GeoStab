# Define los grupos de servidores a los que Nginx puede redirigir el tráfico.
# Los nombres 'api' y 'ui' son resueltos por Docker a las IPs de los contenedores.

upstream api_server {
    # El servicio de Nattan (FastAPI)
    server api:8000;
}

upstream ui_server {
    # El servicio de Valeria (Streamlit)
    server ui:8501;
}
# Servidor para HTTP (Puerto 80)
# Su única función es redirigir a HTTPS y manejar la validación de Certbot.
server {
    listen 80;
    server_name geostab.duckdns.org;

    # Regla para la validación de Let's Encrypt
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Redirige todo el resto del tráfico a HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# Servidor para HTTPS (Puerto 443)
# Aquí ocurre toda la lógica del proxy inverso.
server {
    listen 443 ssl;
    server_name geostab.duckdns.org;

    # Rutas a los certificados que Certbot creará
    ssl_certificate /etc/letsencrypt/live/geostab.duckdns.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/geostab.duckdns.org/privkey.pem;

    # Mejoras de seguridad SSL
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:ECDHE-RSA-AES128-GCM-SHA256';

    # Regla para la API
    location /api/ {
        # Reescribe la URL para quitar el prefijo /api antes de pasarla a FastAPI
        # Ejemplo: /api/analyze/planar -> /analyze/planar
        rewrite /api/(.*) /$1 break;

        proxy_pass http://api_server; # Envía la solicitud a la API
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Regla para la UI
    location / {
        proxy_pass http://ui_server; # Envía la solicitud a la UI de Streamlit
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}